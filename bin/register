#!/usr/bin/env node

'use strict'

function register(options, on_register) {
  
  function sign(plain, private_key) {
    return private_key.hashAndSign(
      'sha256',
      plain,
      'utf8',
      'base64',
      false
    )
  }

  function parse_res(res, on_parsed) {
    var r = ''
    res.on('data', function(data) {
      r += data
    }).on('end', function() {
      try {
        r = JSON.parse(r)
      } catch (e) {
        return on_parsed(e)
      }
      if (r.error) return on_parsed(new Error(r.message))
      return on_parsed(null, r)
    })
  }

  function request(method, path, headers, body, on_send) {
    var h = {'content-type': 'application/json'}
    if (headers) {
      Object.keys(headers).forEach(function(k) {
        h[k] = headers[k]
      })
    }
    return http.request({
      host: 'staging.api.lifekey.cnsnt.io',
      path: path,
      method: method,
      headers: h
    }).on('response', function(res) {
      parse_res(res, function(err, r) {
      if (err) return on_send(err)
      return on_send(null, r.body)
    })
    }).on('error', on_send).end(body || null)
  }
  
  if (!(options.email &&
        options.nickname &&
        options.private_key &&
        options.webhook_scheme &&
        options.webhook_hostname &&
        options.webhook_port &&
        options.webhook_path)) {
    return on_register(new Error('missing required arguments'))
  }

  var plaintext_proof = '' + Date.now()

  try {
    var public_key = options.private_key.toPublicPem('utf8')
    var signed_proof = sign(plaintext_proof, options.private_key)
  } catch (e) {
    return on_register(e)
  }

  var webhook_url = (
    options.webhook_scheme +
    options.webhook_hostname +
    (!options.webhook_port || options.webhook_port === 80 || options.webhook_port === '80' ? '' : ':' + options.webhook_port) +
    options.webhook_path
  )

  request(
    'post',
    '/management/register',
    {},
    JSON.stringify({
      email: options.email,
      nickname: options.nickname,
      webhook_url: webhook_url,
      public_key_algorithm: 'rsa',
      public_key: public_key,
      plaintext_proof: plaintext_proof,
      signed_proof: signed_proof
    }),
    on_register
  )
}

var fs = require('fs')
var http = require('http')

try {
  var args = JSON.parse(process.argv[2])
} catch (e) {
  console.log(e)
  process.exit(1)
}

var ursa = require('ursa')
args.private_key = ursa.generatePrivateKey(4096)

register(args, function(err, res) {
  if (err) {
    console.log('error while attemtping to register', err)
    process.exit(1)
  }
  
  // log the credentials
  console.log(
    JSON.stringify({
      USER_ID: res.id,
      SIGNING_KEY_PEM: args.private_key.toPrivatePem('utf8')
    }, '\t', 2)
  )

  process.exit(0)
})